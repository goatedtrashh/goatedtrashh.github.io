<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML Game Vault - Final Edition</title>
    
    <style>
        @keyframes rotateArrow {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(180deg);
            }
        }

        * {
            box-sizing: border-box;
        }

        body { 
            margin: 0; 
            font-family: 'Segoe UI', sans-serif; 
            background: 
                radial-gradient(circle at 20% 20%, rgba(203, 213, 225, 0.35) 1px, transparent 1px),
                radial-gradient(circle at 80% 30%, rgba(203, 213, 225, 0.32) 1px, transparent 1px),
                radial-gradient(circle at 60% 70%, rgba(148, 163, 184, 0.32) 1px, transparent 1px),
                radial-gradient(circle at 30% 80%, rgba(148, 163, 184, 0.30) 1px, transparent 1px),
                linear-gradient(180deg, #1a1f2e 0%, #141820 100%);
            background-size: 200px 200px, 240px 240px, 260px 260px, 220px 220px, 100% 100%;
            background-attachment: fixed;
            color: #cbd5e1; 
            overflow: auto; 
        }

        body.fullscreen-mode {
            overflow: hidden;
        }
            
        #manager-ui { 
            padding: 1rem; 
            padding-top: 2rem;
            max-width: 100%;
            margin: 0 auto; 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column; 
        }

        .toolbar { 
            background: linear-gradient(135deg, #1e293b 0%, #24334d 100%); 
            padding: 1rem; 
            border-radius: 12px; 
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3), 0 0 12px rgba(59, 130, 246, 0.18); 
            margin-bottom: 1rem; 
            position: relative; 
            z-index: 100; 
            overflow: visible;
            display: flex;
            flex-direction: column;
            margin-top: 50px;
        }

        .watermark-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0px;
            margin-bottom: 20px;
            position: absolute;
            top: -80px;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            z-index: 1;
        }
        
        .search-row { 
            display: flex; 
            flex-direction: column;
            gap: 10px; 
            position: relative; 
            align-items: stretch;
            padding-top: 0;
        }

        @media (min-width: 768px) {
            .search-row {
                flex-direction: row;
                align-items: center;
            }
        }
        
        .cat-selector-wrapper { 
            position: relative; 
            min-width: 200px;
            flex: 0 0 auto;
            margin: 0;
        }

        .cat-trigger { 
            width: 100%; 
            padding: 12px 35px 12px 15px; 
            border-radius: 8px; 
            border: 1px solid #334155; 
            background: #0f172a; 
            color: white; 
            cursor: pointer; 
            text-align: left; 
            font-weight: 600;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat; 
            background-position: right 12px center; 
            background-size: 16px;
            transition: all 0.3s ease;
            height: 40px;
            display: flex;
            align-items: center;
        }

        .cat-trigger.open { 
            border-bottom-left-radius: 0; 
            border-bottom-right-radius: 0;
            animation: rotateArrow 0.3s ease forwards;
        }

        .cat-menu { 
            position: absolute; 
            top: 100%; 
            left: 0; 
            right: 0; 
            background: #1e293b; 
            border: none;
            border-top: none; 
            border-radius: 0 0 8px 8px; 
            max-height: 0; 
            overflow: hidden;
            z-index: 1000;
            transition: max-height 0.3s ease-out;
        }

        .cat-menu.open { 
            max-height: 400px;
            overflow-y: scroll;
            border: 1px solid #334155;
            border-top: none;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }

        .cat-menu.open::-webkit-scrollbar {
            display: none;
        }

        .cat-option { 
            padding: 10px 15px; 
            cursor: pointer; 
            transition: 0.2s; 
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cat-option:hover { 
            background: #3b82f6; 
            color: white; 
        }

        .cat-delete-btn {
            background: #ef4444;
            border: none;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 4px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .cat-option:hover .cat-delete-btn {
            display: flex;
        }

        .button-group { 
            display: flex;
            gap: 10px; 
            align-items: center;
            position: relative;
            z-index: 10;
            margin-bottom: 10px;
            padding-bottom: 0;
        }

        .button-group-content {
            display: flex;
            gap: 10px;
            align-items: center;
            flex: 1;
        }

        button { 
            padding: 10px 18px; 
            cursor: pointer; 
            border: none; 
            border-radius: 8px; 
            font-weight: 600; 
            background: #3b82f6; 
            color: white; 
            transition: 0.2s;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        @media (max-width: 480px) {
            button {
                font-size: 0.85rem;
                padding: 10px 12px;
            }
        }

        button:hover { 
            background: #2563eb; 
            transform: translateY(-1px); 
        }

        #download-btn {
            padding: 10px;
            width: 40px;
            justify-content: center;
            flex-shrink: 0;
        }

        .middle-buttons {
            display: flex;
            gap: 10px;
            flex: 1;
        }

        .middle-buttons button {
            flex: 1;
            flex-shrink: 1;
        }

        #delete-btn-wrapper {
            flex-shrink: 0;
        }

        #delete-btn-wrapper button {
            flex-shrink: 0;
        }

        input[type="text"], select { 
            padding: 12px; 
            border-radius: 8px; 
            border: 1px solid #334155; 
            background: #0f172a; 
            color: white; 
            outline: none;
            height: 40px;
            box-sizing: border-box;
            font-size: 1rem;
            width: 100%;
        }

        @media (min-width: 768px) {
            input[type="text"], select {
                width: auto;
                flex: 1;
            }
        }
        
        #file-grid-wrapper { 
            flex-grow: 1; 
            overflow: visible; 
            padding: 20px 0; 
        }

        #file-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(min(100%, 150px), 1fr));
            gap: 15px;
            width: 100%;
            padding: 20px 0;
            margin: 0;
        }

        @media (min-width: 480px) {
            #file-grid {
                grid-template-columns: repeat(auto-fill, minmax(min(100%, 180px), 1fr));
                gap: 20px;
            }
        }

        @media (min-width: 768px) {
            #file-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
        }

        @media (min-width: 1024px) {
            #file-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (min-width: 1400px) {
            #file-grid {
                grid-template-columns: repeat(5, 1fr);
            }
        }
        
        .file-hitbox { 
            aspect-ratio: 1/1; 
            position: relative; 
            cursor: pointer; 
            z-index: 1;
        }
        
        .file-box { 
            position: absolute; 
            inset: 0; 
            background: #1e293b; 
            border: 2px solid #334155; 
            border-radius: 16px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            padding: 20px; 
            transition: 0.3s; 
            text-align: center; 
            pointer-events: none; 
            box-shadow: 0 0 10px rgba(51, 65, 85, 0.22);
            overflow: hidden;
            word-break: break-word;
        }

        .file-name {
            font-size: clamp(0.7rem, 2vw, 1rem);
            font-weight: 600;
        }

        .file-cat {
            font-size: clamp(0.65rem, 1.5vw, 0.85rem);
            opacity: 0.8;
        }

        .file-hitbox:hover .file-box { 
            border-color: #3b82f6; 
            background: #24334d; 
            transform: translateY(-8px); 
            box-shadow: 0 15px 25px -5px rgba(0, 0, 0, 0.6); 
        }

        @media (max-width: 768px) {
            .file-hitbox:hover .file-box {
                transform: translateY(-4px);
            }
        }

        .file-hitbox.selected .file-box { 
            border-color: #3b82f6; 
            background: #1e3a8a; 
            transform: scale(0.95); 
        }

        .delete-btn { 
            position: absolute; 
            top: 8px; 
            right: 8px; 
            background: #ef4444; 
            padding: 6px 10px; 
            border-radius: 999px; 
            font-size: 0.8rem; 
            z-index: 100 !important; 
            visibility: visible;
            transition: 0.3s;
            opacity: 0; 
            pointer-events: none;
            height: auto;
            display: block;
        }

        .file-hitbox:hover .delete-btn {
            opacity: 1;
            transform: translateY(-8px);
            pointer-events: auto;
        }

        @media (max-width: 768px) {
            .file-hitbox:hover .delete-btn {
                transform: translateY(-4px);
            }
        }

        .file-hitbox.selected .delete-btn { 
            transform: translateY(0) scale(0.95); 
            opacity: 1;
        }

        #bulk-cat-container select, #modal-search, #bulk-cat-container input, #delete-search { 
            height: 40px; 
            padding: 0 12px; 
            box-sizing: border-box;
        }

        #bulk-cat-select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 35px;
        }

        /* Pop-up Modal */
        #cat-modal { 
            display: none; 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.9); 
            z-index: 10000; 
            padding: 1rem;
            overflow: hidden; 
        }

        .modal-content { 
            max-width: 100%;
            margin: 0 auto; 
            background: #111827; 
            padding: 1.5rem; 
            border-radius: 20px; 
            border: 1px solid #334155; 
            display: flex; 
            flex-direction: column; 
            max-height: calc(100vh - 2rem);
            overflow: hidden;
        }

        @media (min-width: 768px) {
            .modal-content {
                max-width: 1100px;
                padding: 2rem;
                max-height: calc(100vh - 3rem);
            }
        }

        .modal-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start;
            margin-bottom: 20px; 
            flex-wrap: wrap; 
            gap: 10px;
            flex-shrink: 0;
        }

        @media (min-width: 768px) {
            .modal-header {
                align-items: center;
                margin-bottom: 25px;
                gap: 15px;
            }
        }

        .modal-header h2 {
            margin: 0;
            display: flex;
            align-items: center;
            height: 40px;
            font-size: clamp(1.2rem, 4vw, 1.8rem);
            width: 100%;
        }

        @media (min-width: 768px) {
            .modal-header h2 {
                width: auto;
            }
        }

        .modal-header button { 
            height: 40px; 
            padding: 0 18px;
            display: flex;
            align-items: center;
        }

        .modal-header > div {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            flex-shrink: 0;
        }

        @media (min-width: 768px) {
            .modal-header > div {
                flex-direction: row;
                width: auto;
            }
        }

        .modal-grid-wrapper { 
            flex: 1; 
            min-height: 0; 
            overflow-y: auto;
            overflow-x: hidden;
        }

        #modal-grid { 
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(min(100%, 150px), 1fr));
            gap: 15px;
            padding: 0 20px 20px 0;
            margin: 0;
            box-sizing: border-box;
        }

        @media (min-width: 480px) {
            #modal-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
                gap: 20px;
            }
        }

        @media (min-width: 768px) {
            #modal-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
        }

        @media (min-width: 1024px) {
            #modal-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (min-width: 1400px) {
            #modal-grid {
                grid-template-columns: repeat(5, 1fr);
            }
        }

        #modal-grid::-webkit-scrollbar {
            display: none;
        }

        /* Delete Modal */
        #delete-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 10000;
            padding: 1rem;
            overflow: hidden;
        }

        .delete-modal-content {
            max-width: 100%;
            margin: 0 auto;
            background: #111827;
            padding: 1.5rem;
            border-radius: 20px;
            border: 1px solid #334155;
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 2rem);
            overflow: hidden;
        }

        @media (min-width: 768px) {
            .delete-modal-content {
                max-width: 1100px;
                padding: 2rem;
                max-height: calc(100vh - 3rem);
            }
        }

        .delete-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
            flex-shrink: 0;
        }

        @media (min-width: 768px) {
            .delete-modal-header {
                align-items: center;
                margin-bottom: 25px;
                gap: 15px;
            }
        }

        .delete-modal-header h2 {
            margin: 0;
            display: flex;
            align-items: center;
            height: 40px;
            font-size: clamp(1.2rem, 4vw, 1.8rem);
            width: 100%;
        }

        @media (min-width: 768px) {
            .delete-modal-header h2 {
                width: auto;
            }
        }

        .delete-modal-header button {
            height: 40px;
            padding: 0 18px;
            display: flex;
            align-items: center;
        }

        .delete-modal-header > div {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            flex-shrink: 0;
        }

        @media (min-width: 768px) {
            .delete-modal-header > div {
                flex-direction: row;
                width: auto;
            }
        }

        .delete-grid-wrapper {
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            overflow-x: hidden;
        }

        #delete-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(min(100%, 150px), 1fr));
            gap: 15px;
            padding: 0 20px 20px 0;
            margin: 0;
            box-sizing: border-box;
        }

        @media (min-width: 480px) {
            #delete-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
                gap: 20px;
            }
        }

        @media (min-width: 768px) {
            #delete-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
        }

        @media (min-width: 1024px) {
            #delete-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (min-width: 1400px) {
            #delete-grid {
                grid-template-columns: repeat(5, 1fr);
            }
        }

        #delete-grid::-webkit-scrollbar {
            display: none;
        }

        .bulk-cat-selector-wrapper {
            position: relative;
            min-width: 150px;
            flex: 0 0 auto;
        }

        .bulk-cat-trigger {
            width: 100%;
            padding: 12px 35px 12px 15px;
            border-radius: 8px;
            border: 1px solid #334155;
            background: #0f172a;
            color: white;
            cursor: pointer;
            text-align: left;
            font-weight: 600;
            box-sizing: border-box;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            transition: all 0.3s ease;
            height: 40px;
            display: flex;
            align-items: center;
        }

        .bulk-cat-trigger.open {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            animation: rotateArrow 0.3s ease forwards;
        }

        .bulk-cat-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #1e293b;
            border: none;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 0;
            overflow: hidden;
            z-index: 1000;
            transition: max-height 0.3s ease-out;
        }

        .bulk-cat-menu.open {
            max-height: 400px;
            overflow-y: scroll;
            border: 1px solid #334155;
            border-top: none;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }

        .bulk-cat-menu.open::-webkit-scrollbar {
            display: none;
        }

        .bulk-cat-option {
            padding: 10px 15px;
            cursor: pointer;
            transition: 0.2s;
            font-size: 0.9rem;
        }

        .bulk-cat-option:hover {
            background: #3b82f6;
            color: white;
        }

        /* Confirmation Dialog */
        #confirm-dialog {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 10001;
            padding: 1rem;
        }

        .confirm-content {
            max-width: 500px;
            margin: 0 auto;
            background: #111827;
            padding: 2rem;
            border-radius: 20px;
            border: 1px solid #334155;
            text-align: center;
        }

        .confirm-content h3 {
            margin: 0 0 15px 0;
            color: white;
            font-size: clamp(1rem, 3vw, 1.3rem);
        }

        .confirm-content p {
            margin: 0 0 25px 0;
            color: #cbd5e1;
            font-size: clamp(0.9rem, 2vw, 1rem);
        }

        .confirm-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .confirm-btn {
            padding: 10px 25px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            height: 40px;
        }

        .confirm-btn.yes {
            background: #22c55e;
            color: white;
        }

        .confirm-btn.yes:hover {
            background: #16a34a;
        }

        .confirm-btn.no {
            background: #ef4444;
            color: white;
        }

        .confirm-btn.no:hover {
            background: #dc2626;
        }

        #executor-ui { 
            display: none; 
            position: fixed; 
            inset: 0; 
            background: #000; 
            z-index: 9999; 
        }

        #executor-ui.fullscreen {
            width: 100vw;
            height: 100vh;
        }

        .exec-btn {
            position: absolute;
            top: 20px;
            z-index: 10001;
            gap: 3px;
        }

        .exec-btn:first-of-type {
            left: 20px;
        }

        .exec-btn:last-of-type {
            left: 100px;
        }

        #executor-ui.fullscreen .exec-btn {
            display: none;
        }

        iframe { 
            width: 100%; 
            height: 100%; 
            border: none; 
        }

        body, #modal-grid { 
            scrollbar-width: none; 
        }

        body::-webkit-scrollbar, #modal-grid::-webkit-scrollbar { 
            width: 0; 
            height: 0; 
        }

        #page-scroll-overlay, #modal-scroll-overlay { 
            display: none;
        }

        .watermark {
            font-weight: 600;
            letter-spacing: 2px;
            color: #cbd5e1;
            opacity: 1;
            user-select: none;
            pointer-events: none;
            white-space: nowrap;
            line-height: 1;
            overflow: hidden;
            text-align: center;
        }

        .watermark.main {
            font-size: clamp(1.5rem, 5vw, 3rem);
        }

        .watermark.credit {
            font-size: clamp(0.9rem, 3vw, 1.5rem);
            letter-spacing: 1px;
        }

        @media (max-width: 480px) {
            .watermark.main {
                font-size: clamp(1.2rem, 4vw, 2rem);
            }

            .watermark.credit {
                font-size: clamp(0.8rem, 2.5vw, 1.1rem);
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@ruffle-rs/ruffle@0.1"></script>
</head>
<body>

<div id="manager-ui">
    
    <div class="toolbar">
        <div class="watermark-section">
            <div class="watermark main">hiddenhub</div>
            <div class="watermark credit">made by trash</div>
        </div>

        <div class="button-group">
            <button id="download-btn" onclick="downloadLibrary()" style="background-image: url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22white%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22%3e%3cpath d=%22M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4%22%3e%3c/path%3e%3cpolyline points=%227 10 12 15 17 10%22%3e%3c/polyline%3e%3cline x1=%2212%22 y1=%221%22 x2=%2212%22 y2=%2215%22%3e%3c/line%3e%3c/svg%3e'); background-repeat: no-repeat; background-position: center; background-size: 15px;" title="Download"></button>
            
            <div class="button-group-content">
                <div class="middle-buttons">
                    <button onclick="document.getElementById('file-picker').click()" style="background-image: url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22white%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22%3e%3cline x1=%2212%22 y1=%225%22 x2=%2212%22 y2=%2219%22%3e%3c/line%3e%3cline x1=%225%22 y1=%2212%22 x2=%2219%22 y2=%2212%22%3e%3c/line%3e%3c/svg%3e'); background-repeat: no-repeat; background-position: 9px center; background-size: 18px; padding-left: 30px;">Add Multiple</button>
                    <button onclick="openCategorizer()">Categorize</button>
                </div>

                <div id="delete-btn-wrapper">
                    <button onclick="openDeleteModal()" style="background:#ef4444; background-image: url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22white%22%3e%3cpath d=%22M19 6.4L17.6 5 12 10.6 6.4 5 5 6.4 10.6 12 5 17.6 6.4 19 12 13.4 17.6 19 19 17.6 13.4 12z%22/%3e%3c/svg%3e'); background-repeat: no-repeat; background-position: 9px center; background-size: 18px; padding-left: 30px;">Delete</button>
                </div>
            </div>

            <input type="file" id="file-picker" accept=".html,.htm" multiple hidden onchange="handleFiles(this)">
        </div>

        <div class="search-row">
            <div class="cat-selector-wrapper">
                <div class="cat-trigger" id="cat-display" onclick="toggleCatMenu()">Category: All</div>
                <div class="cat-menu" id="cat-menu"></div>
            </div>
            <input type="text" id="search-bar" placeholder="Search library..." oninput="renderGrid()">
        </div>
    </div>
    <div id="file-grid-wrapper"><div id="file-grid"></div></div>
</div>

<div id="cat-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Categorize New Games</h2>
            <div>
                <button style="background:#4b5563;" onclick="toggleAllPending()">Select All</button>
                <input type="text" id="modal-search" placeholder="Search new games..." oninput="renderModalGrid()">
                <div class="bulk-cat-selector-wrapper">
                    <div class="bulk-cat-trigger" id="bulk-cat-display" onclick="toggleBulkCatMenu()">General</div>
                    <div class="bulk-cat-menu" id="bulk-cat-menu"></div>
                </div>
                <button onclick="applyBulkCategory()">Categorize</button>
                <button style="background:#ef4444;" onclick="closeModal()">Close</button>
            </div>
        </div>
        <div class="modal-grid-wrapper">
            <div id="modal-grid"></div>
        </div>
    </div>
</div>

<div id="delete-modal">
    <div class="delete-modal-content">
        <div class="delete-modal-header">
            <h2>Delete Games</h2>
            <div>
                <button style="background:#4b5563;" onclick="toggleAllDelete()">Select All</button>
                <input type="text" id="delete-search" placeholder="Search games..." oninput="renderDeleteGrid()">
                <button onclick="deleteSelected()">Delete</button>
                <button style="background:#ef4444;" onclick="closeDeleteModal()">Close</button>
            </div>
        </div>
        <div class="delete-grid-wrapper">
            <div id="delete-grid"></div>
        </div>
    </div>
</div>

<div id="executor-ui">
    <button class="exec-btn" onclick="closeExec()">← Back</button>
    <button class="exec-btn" onclick="toggleFullscreen()">⛶ Fullscreen</button>
    <div id="swf-container" style="width:100%; height:100%;"></div>
</div>

<script id="library-data" type="application/json">[]</script>

<script>
    const STORAGE_KEY = 'gameVaultLibrary';
    const DB_NAME = 'gameVaultDB';
    const STORE_NAME = 'library';
    let db = null;
    let fileList = JSON.parse(document.getElementById('library-data').textContent);
    let storedLibrary = null;
    try { storedLibrary = localStorage.getItem(STORAGE_KEY); } catch (err) {}
    if (storedLibrary) {
        try { fileList = JSON.parse(storedLibrary); } catch (err) {}
    }
    let pendingFiles = [];
    let deleteSelection = [];
    let currentCategory = 'All';
    let currentBulkCategory = 'General';
    const defaultCats = ['Platformer', 'Puzzle', 'Action', 'RPG'];

    function saveLibrary() {
        const data = JSON.stringify(fileList);
        document.getElementById('library-data').textContent = data;
        try { localStorage.setItem(STORAGE_KEY, data); } catch (err) {}
        if (db) {
            const tx = db.transaction(STORE_NAME, 'readwrite');
            tx.objectStore(STORE_NAME).put({ id: 'main', data: fileList });
        }
    }
    
    if (navigator.storage && navigator.storage.persist) {
        navigator.storage.persist();
    }

    function openDb() {
        return new Promise(resolve => {
            if (!('indexedDB' in window)) return resolve(null);
            const request = indexedDB.open(DB_NAME, 1);
            request.onupgradeneeded = e => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                }
            };
            request.onsuccess = e => { db = e.target.result; resolve(db); };
            request.onerror = () => resolve(null);
        });
    }

    function loadFromDb() {
        return openDb().then(activeDb => {
            if (!activeDb) return;
            return new Promise(resolve => {
                const tx = activeDb.transaction(STORE_NAME, 'readonly');
                const store = tx.objectStore(STORE_NAME);
                const req = store.get('main');
                req.onsuccess = () => {
                    if (req.result && Array.isArray(req.result.data)) {
                        fileList = req.result.data;
                        saveLibrary();
                    }
                    resolve();
                };
                req.onerror = () => resolve();
            });
        });
    }

    function getUniqueCats() {
        return ['General', ...new Set([...defaultCats, ...fileList.map(f => f.category || 'General')])];
    }

    function toggleCatMenu() {
        document.getElementById('cat-menu').classList.toggle('open');
        document.getElementById('cat-display').classList.toggle('open');
    }

    function renderCatMenu() {
        const menu = document.getElementById('cat-menu');
        const cats = ['All', ...getUniqueCats()];
        menu.innerHTML = cats.map(c => {
            if (c === 'All') {
                return `<div class="cat-option" onclick="setCategory('${c}')"><span>${c}</span></div>`;
            }
            return `<div class="cat-option" onclick="setCategory('${c}')"><span>${c}</span><button class="cat-delete-btn" onclick="deleteCategory('${c}', event)">×</button></div>`;
        }).join('');
        document.getElementById('cat-display').innerText = "Category: " + currentCategory;
    }

    function deleteCategory(catName, event) {
        event.stopPropagation();
        const gamesInCat = fileList.filter(f => (f.category || 'General') === catName);
        if (gamesInCat.length > 0) {
            showConfirmDialog(`Delete category "${catName}"?`, `${gamesInCat.length} game(s) will be moved to Uncategorized.`, () => {
                fileList.forEach(f => {
                    if ((f.category || 'General') === catName) {
                        f.category = 'General';
                    }
                });
                saveLibrary();
                renderCatMenu();
                renderGrid();
            });
        } else {
            showConfirmDialog(`Delete category "${catName}"?`, 'This category is empty.', () => {
                saveLibrary();
                renderCatMenu();
                renderGrid();
            });
        }
    }

    function showConfirmDialog(title, message, onConfirm) {
        const dialog = document.getElementById('confirm-dialog') || createConfirmDialog();
        dialog.querySelector('h3').textContent = title;
        dialog.querySelector('p').textContent = message;
        dialog.querySelector('.confirm-btn.yes').onclick = () => {
            onConfirm();
            dialog.style.display = 'none';
        };
        dialog.querySelector('.confirm-btn.no').onclick = () => {
            dialog.style.display = 'none';
        };
        dialog.style.display = 'block';
    }

    function createConfirmDialog() {
        const dialog = document.createElement('div');
        dialog.id = 'confirm-dialog';
        dialog.innerHTML = `
            <div class="confirm-content">
                <h3></h3>
                <p></p>
                <div class="confirm-buttons">
                    <button class="confirm-btn yes">✓ Confirm</button>
                    <button class="confirm-btn no">✕ Cancel</button>
                </div>
            </div>
        `;
        document.body.appendChild(dialog);
        return dialog;
    }

    function setCategory(cat) {
        currentCategory = cat;
        renderCatMenu();
        toggleCatMenu();
        renderGrid();
    }

    function toggleBulkCatMenu() {
        document.getElementById('bulk-cat-menu').classList.toggle('open');
        document.getElementById('bulk-cat-display').classList.toggle('open');
    }

    function renderBulkCatMenu() {
        const menu = document.getElementById('bulk-cat-menu');
        const cats = getUniqueCats();
        menu.innerHTML = cats.map(c => `<div class="bulk-cat-option" onclick="setBulkCategory('${c}')">${c}</div>`).join('');
    }

    function setBulkCategory(cat) {
        currentBulkCategory = cat;
        document.getElementById('bulk-cat-display').textContent = cat;
        toggleBulkCatMenu();
    }

    function renderGrid() {
        const grid = document.getElementById('file-grid');
        const query = document.getElementById('search-bar').value.toLowerCase();
        const filtered = fileList.filter(f =>
            (currentCategory === 'All' || (f.category || 'General') === currentCategory) &&
            f.name.toLowerCase().includes(query)
        );

        grid.innerHTML = filtered.map((f) => {
            const realIndex = fileList.indexOf(f);
            return `
            <div class="file-hitbox" onclick="runFile(${realIndex})">
                <button class="delete-btn" onclick="deleteGame(${realIndex}, event)">Delete</button>
                <div class="file-box">
                    <div class="file-name">${f.name}</div>
                    <div class="file-cat">${f.category || 'General'}</div>
                </div>
            </div>`;
        }).join('');
    }

    async function handleFiles(input) {
        const files = Array.from(input.files);
        const entries = await Promise.all(files.map(async file => {
            const content = await file.text();
            return { name: file.name.replace(/\.[^/.]+$/, ""), content, selected: false };
        }));
        pendingFiles.push(...entries);
        document.getElementById('cat-modal').style.display = 'block';
        renderBulkCatMenu();
        renderModalGrid();
        input.value = '';
    }

    function renderModalGrid() {
        const query = (document.getElementById('modal-search')?.value || '').toLowerCase();
        const filtered = pendingFiles
            .map((f, i) => ({ f, i }))
            .filter(({ f }) => f.name.toLowerCase().includes(query));
        document.getElementById('modal-grid').innerHTML = filtered.map(({ f, i }) => `
            <div class="file-hitbox ${f.selected ? 'selected' : ''}" onclick="toggleSelect(${i})">
                <div class="file-box"><div class="file-name">${f.name}</div><div class="file-cat">Unsorted</div></div>
            </div>`).join('');
    }

    function openCategorizer() {
        document.getElementById('cat-modal').style.display = 'block';
        pendingFiles = [];
        currentBulkCategory = 'General';
        renderBulkCatMenu();
        renderModalGrid();
    }

    function openDeleteModal() {
        deleteSelection = fileList.map((f, i) => ({ ...f, idx: i, selected: false }));
        document.getElementById('delete-modal').style.display = 'block';
        renderDeleteGrid();
    }

    function closeDeleteModal() {
        document.getElementById('delete-modal').style.display = 'none';
        deleteSelection = [];
    }

    function closeModal() {
        document.getElementById('cat-modal').style.display = 'none';
        pendingFiles = [];
    }

    function toggleSelect(idx) {
        pendingFiles[idx].selected = !pendingFiles[idx].selected;
        renderModalGrid();
    }

    function toggleAllPending() {
        const allSelected = pendingFiles.every(f => f.selected);
        pendingFiles.forEach(f => f.selected = !allSelected);
        renderModalGrid();
    }

    function toggleAllDelete() {
        const allSelected = deleteSelection.every(f => f.selected);
        deleteSelection.forEach(f => f.selected = !allSelected);
        renderDeleteGrid();
    }

    function renderDeleteGrid() {
        const query = (document.getElementById('delete-search')?.value || '').toLowerCase();
        const filtered = deleteSelection.filter(f => f.name.toLowerCase().includes(query));
        document.getElementById('delete-grid').innerHTML = filtered.map(f => `
            <div class="file-hitbox ${f.selected ? 'selected' : ''}" onclick="toggleDeleteSelect(${f.idx})">
                <div class="file-box"><div class="file-name">${f.name}</div><div class="file-cat">${f.category || 'General'}</div></div>
            </div>`).join('');
    }

    function toggleDeleteSelect(idx) {
        const item = deleteSelection.find(f => f.idx === idx);
        if (item) item.selected = !item.selected;
        renderDeleteGrid();
    }

    function applyBulkCategory() {
        pendingFiles.filter(f => f.selected).forEach(f => {
            fileList.push({ name: f.name, content: f.content, category: currentBulkCategory });
        });
        saveLibrary();
        renderCatMenu();
        renderGrid();
        closeModal();
    }

    function deleteSelected() {
        const toDelete = deleteSelection.filter(f => f.selected).map(f => f.idx).sort((a, b) => b - a);
        toDelete.forEach(idx => fileList.splice(idx, 1));
        saveLibrary();
        renderCatMenu();
        renderGrid();
        closeDeleteModal();
    }

    function deleteGame(idx, event) {
        event.stopPropagation();
        showConfirmDialog('Delete Game?', `Are you sure you want to delete "${fileList[idx].name}"?`, () => {
            fileList.splice(idx, 1);
            saveLibrary();
            renderCatMenu();
            renderGrid();
        });
    }

    function runFile(idx) {
        const file = fileList[idx];
        const content = file.content;
        
        // Check if it's a SWF file
        if (content.includes('FWS') || content.includes('CWS')) {
            // It's a SWF file - use Ruffle
            const binaryString = atob(btoa(content));
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            const blob = new Blob([bytes], { type: 'application/x-shockwave-flash' });
            const url = URL.createObjectURL(blob);
            
            const container = document.getElementById('swf-container');
            container.innerHTML = `<ruffle-player src="${url}" style="width:100%; height:100%;"></ruffle-player>`;
            document.getElementById('executor-ui').style.display = 'block';
  } else {
    // 1. Get the folder path where your launcher is sitting on GitHub
    const currentPath = window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1);

    // 2. Build a "wrapper" that fixes the URL and Ruffle context
    // This adds the <base> tag and the Ruffle script automatically
    const wrapper = `
        <!DOCTYPE html>
        <html>
        <head>
            <base href="${currentPath}">
            <script src="https://cdn.jsdelivr.net"></script>
            <style>body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; }</style>
        </head>
        <body>
            ${content}
        </body>
        </html>
    `;

    // 3. Create the iframe and load it
    const iframe = document.createElement('iframe');
    const blob = new Blob([wrapper], { type: 'text/html' });
    iframe.src = URL.createObjectURL(blob);
    
    iframe.style.width = '100%';
    iframe.style.height = '100%';
    iframe.style.border = 'none';
    
    const container = document.getElementById('swf-container');
    container.innerHTML = '';
    container.appendChild(iframe);
    document.getElementById('executor-ui').style.display = 'block';
}

    function closeExec() {
        document.getElementById('executor-ui').style.display = 'none';
        document.getElementById('swf-container').innerHTML = '';
        document.getElementById('executor-ui').classList.remove('fullscreen');
    }

    function toggleFullscreen() {
        document.getElementById('executor-ui').classList.toggle('fullscreen');
    }

    function downloadLibrary() {
        const data = JSON.stringify(fileList, null, 2);
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'game-vault-backup.json';
        a.click();
        URL.revokeObjectURL(url);
    }

    document.addEventListener('click', (e) => {
        if (!e.target.closest('.cat-selector-wrapper')) {
            document.getElementById('cat-menu').classList.remove('open');
            document.getElementById('cat-display').classList.remove('open');
        }
        if (!e.target.closest('.bulk-cat-selector-wrapper')) {
            document.getElementById('bulk-cat-menu').classList.remove('open');
            document.getElementById('bulk-cat-display').classList.remove('open');
        }
    });

    renderCatMenu();
    loadFromDb().then(() => {
        renderCatMenu();
        renderGrid();
    });
</script>
</body>
</html>
